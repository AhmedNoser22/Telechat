@if(chatService.currentOpenedChat()){
<div class="flex flex-col h-full rounded-[2.5rem] shadow-2xl overflow-hidden border border-pink-100 relative"
     style="background-color: #fff1f2 !important;" (click)="closeContextMenu()">

  <div class="flex items-center justify-between px-6 py-4 bg-white/50 backdrop-blur-md border-b border-pink-100 z-20">
    <div class="flex items-center gap-3">
      <div class="relative">
        <img class="h-11 w-11 rounded-2xl object-cover border-2 border-pink-100 shadow-sm" [src]="chatService.currentOpenedChat()?.profilePicture">
        <div class="absolute -bottom-0.5 -right-0.5 h-3 w-3 rounded-full border-2 border-white"
             [class.bg-pink-400]="chatService.currentOpenedChat()?.isOnline"
             [class.bg-slate-300]="!chatService.currentOpenedChat()?.isOnline"></div>
      </div>
      <div>
        <h2 class="text-slate-800 font-black text-sm leading-tight">{{ chatService.currentOpenedChat()?.fullName }}</h2>
        <div class="flex items-center gap-1 mt-0.5">
          @if(chatService.isTyping()) {
            <span class="flex items-center gap-1">
              <span class="typing-dot"></span>
              <span class="typing-dot" style="animation-delay:.15s"></span>
              <span class="typing-dot" style="animation-delay:.3s"></span>
              <span class="text-[10px] font-bold text-pink-400 ml-1">typing</span>
            </span>
          } @else {
            <p class="text-[10px] font-bold uppercase tracking-widest"
               [class.text-pink-400]="chatService.currentOpenedChat()?.isOnline"
               [class.text-slate-400]="!chatService.currentOpenedChat()?.isOnline">
              {{ chatService.currentOpenedChat()?.isOnline ? 'Online' : 'Offline' }}
            </p>
          }
        </div>
      </div>
    </div>
    <div class="flex items-center gap-0.5">
      @if(!chatService.isChatBlocked() && !chatService.blockedByOther()) {
        <button (click)="startVoiceCall()" class="p-2.5 hover:bg-pink-50 text-pink-400 rounded-full transition-all active:scale-90">
          <mat-icon class="!text-[20px]">call</mat-icon>
        </button>
        <button (click)="startVideoCall()" class="p-2.5 hover:bg-pink-50 text-pink-400 rounded-full transition-all active:scale-90">
          <mat-icon class="!text-[20px]">videocam</mat-icon>
        </button>
      }
      <button (click)="chatService.currentOpenedChat.set(null)" class="p-2.5 hover:bg-pink-50 text-pink-300 rounded-full transition-all active:scale-90">
        <mat-icon class="!text-[20px]">close</mat-icon>
      </button>
    </div>
  </div>

  <div #scrollMe class="flex-1 overflow-y-auto px-5 py-4 space-y-3 custom-scrollbar"
       style="background: linear-gradient(180deg, #fff1f2 0%, #ffe4e6 100%);">
    @for (item of chatService.chatMessages(); track item.id) {
      <div class="flex flex-col"
           [class.items-end]="item.senderId === authService.currentLoggedUser()?.id"
           [class.items-start]="item.senderId !== authService.currentLoggedUser()?.id">
        <div (contextmenu)="onRightClick($event, item)"
             class="max-w-[75%] px-4 py-3 rounded-2xl shadow-sm cursor-pointer transition-all hover:shadow-md"
             [class.rounded-tr-sm]="item.senderId === authService.currentLoggedUser()?.id"
             [class.rounded-tl-sm]="item.senderId !== authService.currentLoggedUser()?.id"
             [style.background]="item.senderId === authService.currentLoggedUser()?.id ? 'linear-gradient(135deg,#f472b6,#fb7185)' : 'white'"
             [class.text-white]="item.senderId === authService.currentLoggedUser()?.id"
             [class.text-slate-800]="item.senderId !== authService.currentLoggedUser()?.id"
             [class.border]="item.senderId !== authService.currentLoggedUser()?.id"
             [class.border-pink-100]="item.senderId !== authService.currentLoggedUser()?.id">
          <span class="text-sm font-medium leading-relaxed">{{item.content}}</span>
          <div class="flex items-center justify-end gap-1 mt-1.5">
            <span class="text-[9px] opacity-60 font-semibold">{{ chatService.formatEgyptTime(item.createDate) }}</span>
            @if(item.senderId === authService.currentLoggedUser()?.id) {
              <mat-icon class="!text-[13px] !w-[13px] !h-[13px]"
                        [class.text-blue-200]="item.isRead"
                        [class.text-white/60]="!item.isRead">
                {{ item.isRead ? 'done_all' : 'done' }}
              </mat-icon>
            }
          </div>
        </div>
      </div>
    }
  </div>

  @if (contextMenuVisible()) {
    <div class="fixed z-[100] bg-white shadow-2xl border border-pink-100 rounded-2xl py-2 min-w-[180px]"
         style="animation: popIn .12s cubic-bezier(.34,1.56,.64,1) both;"
         [style.top.px]="contextMenuTop()" [style.left.px]="contextMenuLeft()">
      <button (click)="forwardMessage()" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-pink-50 text-slate-700 transition-colors">
        <mat-icon class="text-pink-400 !text-base !w-4 !h-4">forward</mat-icon>
        <span class="text-xs font-bold">Forward Message</span>
      </button>
      <button (click)="deleteForMe()" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-pink-50 text-slate-700 transition-colors">
        <mat-icon class="text-pink-400 !text-base !w-4 !h-4">delete_outline</mat-icon>
        <span class="text-xs font-bold">Delete for Me</span>
      </button>
      @if(selectedMessageId()) {
        <button (click)="deleteForEveryone()" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-pink-50 text-red-500 transition-colors">
          <mat-icon class="text-red-400 !text-base !w-4 !h-4">delete_forever</mat-icon>
          <span class="text-xs font-bold">Delete for Everyone</span>
        </button>
      }
    </div>
  }

  <div class="px-4 py-3 border-t border-pink-100" style="background: rgba(255,255,255,0.6); backdrop-filter: blur(12px);">
    @if (chatService.isChatBlocked() || chatService.blockedByOther()) {
      <div class="flex items-center justify-center gap-2 bg-pink-50 py-4 px-5 rounded-[1.5rem] border border-pink-100">
        <mat-icon class="text-pink-300 !text-lg">block</mat-icon>
        <span class="text-pink-400 font-black text-xs uppercase text-center">
          {{ chatService.isChatBlocked() ? 'You blocked this contact' : 'You can\'t send messages' }}
        </span>
      </div>
    } @else {
      <div class="flex items-center gap-2.5 bg-white rounded-[1.5rem] p-2 shadow-lg border border-pink-100">
        <button (mousedown)="startRecording()" (mouseup)="stopRecording()"
                class="p-2.5 rounded-full transition-all flex-shrink-0"
                [class.text-pink-400]="!isRecording"
                [class.text-white]="isRecording"
                [style.background]="isRecording ? 'linear-gradient(135deg,#f472b6,#fb7185)' : 'transparent'">
          <mat-icon class="!text-[20px]" [class.animate-pulse]="isRecording">{{ isRecording ? 'mic' : 'mic_none' }}</mat-icon>
        </button>
        <input type="text" [(ngModel)]="message" (keydown.enter)="sendMessage()" (input)="onTyping()"
               class="flex-1 bg-transparent text-sm outline-none text-slate-700 placeholder-pink-200 font-medium"
               placeholder="Type a message...">
        <button (click)="sendMessage()"
                class="p-3 rounded-xl text-white shadow-md active:scale-95 transition-all flex-shrink-0"
                style="background: linear-gradient(135deg, #f472b6, #fb7185);">
          <mat-icon class="!text-[20px]">send</mat-icon>
        </button>
      </div>
    }
  </div>
</div>
} @else {
<div class="flex flex-col h-full w-full rounded-[2.5rem] items-center justify-center p-12 border border-pink-100 shadow-2xl relative overflow-hidden"
     style="background-color: #fff1f2 !important;">
  <div class="absolute -top-24 -right-24 w-64 h-64 bg-pink-200/30 rounded-full blur-3xl"></div>
  <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-rose-200/30 rounded-full blur-3xl"></div>

  <div class="relative z-10 flex flex-col items-center" style="animation: fadeZoom .7s cubic-bezier(.34,1.56,.64,1) both;">
    <div class="relative w-32 h-32 mb-8">
      <div class="absolute inset-0 rounded-[2.5rem] rotate-6 opacity-25" style="background: linear-gradient(135deg,#f9a8d4,#fb7185);"></div>
      <div class="absolute inset-0 rounded-[2.5rem] -rotate-6 opacity-15" style="background: linear-gradient(135deg,#fda4af,#f472b6);"></div>
      <div class="relative w-full h-full rounded-[2.5rem] flex items-center justify-center shadow-2xl shadow-pink-200 overflow-hidden"
           style="background: linear-gradient(135deg,#f472b6 0%,#fb7185 50%,#fda4af 100%);">
        <svg width="64" height="64" viewBox="0 0 68 68" fill="none" style="filter:drop-shadow(0 2px 8px rgba(244,114,182,.3))">
          <rect x="6" y="8" width="44" height="32" rx="12" fill="white" fill-opacity="0.95"/>
          <rect x="14" y="16" width="28" height="3.5" rx="1.75" fill="#f472b6"/>
          <rect x="14" y="22.5" width="20" height="3.5" rx="1.75" fill="#fda4af"/>
          <path d="M6 36 L14 44 L14 36 Z" fill="white" fill-opacity="0.95"/>
          <rect x="20" y="30" width="42" height="28" rx="11" fill="white" fill-opacity="0.85"/>
          <rect x="27" y="38" width="28" height="3" rx="1.5" fill="#fb7185"/>
          <rect x="27" y="44" width="18" height="3" rx="1.5" fill="#fda4af"/>
          <path d="M62 54 L54 62 L54 54 Z" fill="white" fill-opacity="0.85"/>
          <circle cx="51" cy="20" r="10" fill="#fb7185"/>
          <path d="M47 20 L50 23 L55 17" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="check-path"/>
        </svg>
      </div>
      <div class="pulse-ring absolute inset-0 rounded-[2.5rem]"></div>
    </div>
    <h1 class="text-2xl font-black text-slate-800 tracking-tighter text-center">Select a contact</h1>
    <p class="text-pink-300 text-sm font-medium mt-1.5 text-center">Start a conversation âœ¦</p>
    <div class="mt-5 flex gap-2">
      <div class="w-2 h-2 rounded-full bg-pink-300 animate-bounce" style="animation-delay:.1s"></div>
      <div class="w-2 h-2 rounded-full bg-pink-400 animate-bounce" style="animation-delay:.22s"></div>
      <div class="w-2 h-2 rounded-full bg-rose-400 animate-bounce" style="animation-delay:.34s"></div>
    </div>
  </div>
</div>
}

<style>
  .custom-scrollbar::-webkit-scrollbar { width: 5px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #fda4af; border-radius: 10px; }
  @keyframes fadeZoom { from{opacity:0;transform:scale(.88)} to{opacity:1;transform:scale(1)} }
  @keyframes popIn { from{transform:scale(.8);opacity:0} to{transform:scale(1);opacity:1} }
  .typing-dot {
    display:inline-block; width:3px; height:3px; border-radius:50%; background:#f472b6;
    animation: typingBounce .6s infinite alternate;
  }
  @keyframes typingBounce { from{transform:translateY(0)} to{transform:translateY(-3px)} }
  .pulse-ring {
    border: 2px solid #f9a8d4; pointer-events:none;
    animation: pulseRing 2.5s cubic-bezier(.4,0,.6,1) infinite;
  }
  @keyframes pulseRing { 0%,100%{opacity:.5;transform:scale(1)} 50%{opacity:0;transform:scale(1.12)} }
  .check-path {
    stroke-dasharray:16; stroke-dashoffset:16;
    animation: drawCheck 1.2s .5s cubic-bezier(.4,0,.2,1) infinite;
  }
  @keyframes drawCheck { 0%{stroke-dashoffset:16} 60%,100%{stroke-dashoffset:0} }
</style>